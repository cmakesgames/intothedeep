<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Into The Deep - Made by CMG</title>
<style>
    :root {
        --bg: #050505; --panel: #0e0e0e; --border: #333;
        --gold: #ffb300; --hp: #d32f2f; --mp: #1976d2; --text: #c0c0c0;
        --theme: #444; 
        --r0: #9e9e9e; --r1: #4caf50; --r2: #2196f3; --r3: #9c27b0; --r4: #ffb300;
    }
    
    body { font-family: 'Courier New', monospace; background: var(--bg); color: var(--text); margin:0; display:flex; justify-content:center; align-items:center; height:100vh; overflow:hidden; user-select:none; }
    * { box-sizing: border-box; }
    
    #app { width: 1100px; height: 95vh; background: var(--panel); border: 1px solid var(--border); display: flex; flex-direction: column; box-shadow: 0 0 50px #000; position: relative; }

    /* Header & Nav */
    header { height: 50px; background: #000; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; padding: 0 20px; }
    .btn-reset { background: #222; border: 1px solid #444; color: #666; cursor: pointer; font-size: 0.7em; padding: 5px; transition: 0.2s; }
    .btn-reset:hover { border-color: var(--hp); color: var(--hp); }

    .nav { display: flex; background: #111; }
    .nav-btn { flex: 1; padding: 15px; background: transparent; border: none; color: #555; font-weight: bold; cursor: pointer; border-right: 1px solid #222; transition: 0.2s; }
    .nav-btn:hover { color: #fff; background: #1a1a1a; }
    .nav-btn.active { background: #1a1a1a; color: var(--gold); border-bottom: 2px solid var(--gold); }

    /* Screens */
    .screen { display: none; flex: 1; padding: 20px; overflow: hidden; flex-direction: column; }
    .screen.active { display: flex; }

    /* Hub */
    .hub-grid { display: flex; gap: 20px; height: 100%; }
    .panel { flex: 1; background: #141414; border: 1px solid #2a2a2a; padding: 15px; display: flex; flex-direction: column; overflow: hidden; }
    .item-grid { overflow-y: auto; display: grid; grid-template-columns: repeat(auto-fill, minmax(190px, 1fr)); gap: 10px; align-content: start; padding-right: 5px; }
    
    /* Cards */
    .card { background: #1a1a1a; border: 1px solid #333; padding: 10px; cursor: pointer; position: relative; transition: 0.1s; }
    .card:hover { background: #222; border-color: #666; transform: translateY(-2px); }
    .card-top { display: flex; justify-content: space-between; align-items: flex-start; }
    .card-name { font-weight: bold; color: #eee; font-size: 0.9em; margin-right: 5px; }
    .card-type { font-size: 0.7em; color: #666; text-transform: uppercase; margin-top: 5px; display: block; }
    .btn-sell { background: #300; border: 1px solid #500; color: #f55; font-size: 0.7em; padding: 2px 6px; cursor: pointer; z-index: 2; }
    .btn-sell:hover { background: #f00; color: #fff; border-color: #fff; }
    
    .r-0 { border-left: 3px solid var(--r0); } .r-1 { border-left: 3px solid var(--r1); }
    .r-2 { border-left: 3px solid var(--r2); } .r-3 { border-left: 3px solid var(--r3); }
    .r-4 { border-left: 3px solid var(--r4); } .r-10 { border-left: 3px solid #d50000; }

    /* Tooltip */
    #tooltip { position: fixed; pointer-events: none; z-index: 2000; background: rgba(0,0,0,0.95); border: 1px solid #555; padding: 15px; width: 250px; display: none; box-shadow: 0 0 20px #000; }
    .tt-title { font-weight: bold; font-size: 1.1em; color: var(--gold); margin-bottom: 5px; display: block; }
    .tt-meta { font-size: 0.8em; color: #888; margin-bottom: 10px; display: block; border-bottom: 1px solid #333; padding-bottom: 5px; }
    .tt-desc { font-size: 0.9em; color: #ccc; line-height: 1.4; }

    /* Loadout */
    .slot { background: #0a0a0a; border: 1px dashed #444; padding: 10px; margin-bottom: 5px; text-align: center; cursor: pointer; color: #555; transition: 0.2s; }
    .slot:hover { background: #111; border-color: #666; }
    .slot.filled { border: 1px solid var(--gold); color: var(--gold); background: rgba(255, 179, 0, 0.05); }
    .btn-start { margin-top: auto; padding: 15px; background: var(--gold); border: none; font-weight: 900; font-size: 1.2em; cursor: pointer; color: #000; text-transform: uppercase; }
    .btn-start:hover { filter: brightness(1.1); }

    /* Traders */
    .trader-row { display: flex; background: #111; border: 1px solid #333; padding: 10px; margin-bottom: 10px; align-items: center; gap: 15px; }
    .trader-info { width: 120px; text-align: center; font-size: 0.9em; }

    /* Game HUD */
    .hud { display: flex; justify-content: space-between; background: #000; padding: 10px 20px; border-bottom: 1px solid #333; align-items: center; }
    .floor-badge { font-size: 1.2em; font-weight: bold; color: var(--theme); text-transform: uppercase; letter-spacing: 2px; }
    .bar { width: 180px; height: 12px; background: #222; border: 1px solid #555; display: inline-block; vertical-align: middle; margin-left: 5px; }
    .fill { height: 100%; transition: width 0.2s; }
    .hp { background: var(--hp); } .mp { background: var(--mp); }

    /* Stage */
    .stage { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
    .narrative { text-align: center; max-width: 600px; margin-bottom: 20px; animation: fade 0.5s; }
    .room-title { font-size: 2.5em; color: #fff; margin: 0 0 10px 0; text-shadow: 0 0 10px var(--theme); }
    .room-desc { font-size: 1.1em; color: #aaa; }

    /* Combat */
    #combat-ui { display: none; width: 600px; flex-direction: column; align-items: center; }
    .enemy-bar { width: 100%; display: flex; background: #111; padding: 15px; border: 1px solid #444; gap: 15px; align-items: center; margin-bottom: 10px; }
    .enemy-hp-bg { flex: 1; height: 12px; background: #222; border: 1px solid #555; }
    .enemy-hp-fill { height: 100%; background: var(--hp); transition: width 0.2s; }
    #canvas-box { width: 600px; height: 350px; background: #000; border: 2px solid #fff; position: relative; display: none; cursor: none; } 
    
    .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 600px; margin-top: 20px; }
    .btn-act { padding: 20px; background: rgba(20,20,20,0.9); border: 1px solid #444; color: #aaa; cursor: pointer; text-align: left; transition: 0.2s; position:relative; }
    .btn-act:hover { background: #222; border-color: var(--theme); color: #fff; }
    .btn-act strong { display: block; color: var(--theme); font-size: 1.1em; margin-bottom: 3px; }
    .btn-heal { grid-column: span 2; text-align: center; border-color: var(--mp); }
    .btn-heal strong { color: var(--mp); }

    /* Overlays */
    .overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.95); z-index: 100; display: none; justify-content: center; align-items: center; flex-direction: column; }
    
    .travel-bar { width: 400px; height: 6px; background: #222; border-radius: 3px; overflow: hidden; margin-top: 20px; }
    .travel-fill { width: 0%; height: 100%; background: var(--gold); transition: width linear; }

    .qte-keys { display: flex; gap: 15px; margin-top: 20px; }
    .key-box { width: 60px; height: 60px; border: 2px solid #555; color: #555; font-size: 2em; display: flex; align-items: center; justify-content: center; font-weight: bold; }
    .key-active { border-color: #fff; color: #fff; background: #222; box-shadow: 0 0 20px #fff; }
    
    .modal-box { background: #111; border: 2px solid var(--gold); width: 450px; padding: 30px; text-align: center; box-shadow: 0 0 50px #000; }
    .modal-btn { background: var(--gold); color: #000; border: none; padding: 10px 20px; font-weight: bold; cursor: pointer; margin-top: 20px; font-size: 1.1em; }
    .loot-text { color: var(--gold); font-size: 1.2em; margin: 10px 0; display: block; }

    @keyframes fade { from{opacity:0; transform:translateY(10px)} to{opacity:1; transform:translateY(0)} }
</style>
</head>
<body>

<div id="tooltip">
    <span class="tt-title" id="tt-title">Item Name</span>
    <span class="tt-meta" id="tt-meta">Rarity | Type</span>
    <div class="tt-desc" id="tt-desc">Description goes here.</div>
</div>

<div id="app">
    <header>
        <div>INTO THE DEEP <span style="color:#555">1.0</span></div>
        <div style="color:var(--gold); font-weight:bold;">ðŸª™ <span id="hud-gold">0</span></div>
        <button class="btn-reset" onclick="wipeData()">WIPE DATA</button>
    </header>

    <nav class="nav" id="nav-bar">
        <button class="nav-btn active" onclick="switchScreen('hub')">INVENTORY</button>
        <button class="nav-btn" onclick="switchScreen('trader')">TRADERS</button>
    </nav>

    <div id="screen-hub" class="screen active">
        <div class="hub-grid">
            <div class="panel" style="flex:2">
                <h3>STASH</h3>
                <div id="stash-grid" class="item-grid"></div>
            </div>
            <div class="panel">
                <h3>LOADOUT</h3>
                <div class="slot" id="slot-weapon" onclick="unequip('weapon')">Weapon</div>
                <div class="slot" id="slot-armor" onclick="unequip('armor')">Armor</div>
                <div class="slot" id="slot-spell1" onclick="unequip('spell1')">Spell 1</div>
                <div class="slot" id="slot-spell2" onclick="unequip('spell2')">Spell 2</div>
                <button class="btn-start" onclick="startRun()">DESCEND</button>
            </div>
        </div>
    </div>

    <div id="screen-trader" class="screen">
        <div class="panel" id="trader-list"></div>
    </div>

    <div id="screen-game" class="screen">
        <div class="hud">
            <div id="floor-room-wrapper" style="display:flex; gap:10px; align-items:center;">
            <div id="floor-txt" class="floor-badge">FLOOR 1</div>
            <div id="room-txt" class="floor-badge">ROOM 1/8</div>
            </div>      
            <div style="text-align:right">
                HP <div class="bar"><div id="bar-hp" class="fill hp" style="width:100%"></div></div>
                MP <div class="bar"><div id="bar-mp" class="fill mp" style="width:100%"></div></div>
            </div>
        </div>

        <div class="stage">
            <div id="narrative" class="narrative">
                <h1 id="room-title" class="room-title">Room 1</h1>
                <p id="room-desc" class="room-desc">The darkness awaits.</p>
            </div>

            <div id="combat-ui">
                <div class="enemy-bar">
                    <div style="font-size:2.5em" id="enemy-icon">ðŸ’€</div>
                    <div style="flex:1">
                        <div style="display:flex; justify-content:space-between; color:#fff">
                            <strong id="enemy-name">Name</strong>
                            <small style="color:var(--hp)">Pattern: <span id="enemy-pat">Rain</span></small>
                        </div>
                        <div class="enemy-hp-bg"><div id="enemy-hp" class="enemy-hp-fill" style="width:100%"></div></div>
                    </div>
                </div>
                <div id="canvas-box">
                    <div style="position:absolute; top:10px; width:100%; text-align:center; color:#444; font-size:0.8em; pointer-events:none;">MOVE WITH WASD OR ARROWS</div>
                    <canvas id="gameCanvas" width="600" height="350"></canvas>
                </div>
            </div>

            <div id="controls" class="controls"></div>
        </div>
    </div>
</div>

<div id="ov-qte" class="overlay">
    <h2 style="color:#fff; margin-bottom:10px;">ATTACK SEQUENCE</h2>
    <div class="qte-keys" id="qte-keys"></div>
</div>

<div id="ov-count" class="overlay" style="background:rgba(0,0,0,0.3);">
    <div style="font-size:5em; color:#fff; text-shadow:0 0 20px #000;" id="count-num">3</div>
    <div style="color:#fff; font-size:1.5em;">PREPARE TO DODGE</div>
</div>

<div id="ov-msg" class="overlay" style="background:rgba(0,0,0,0);">
    <div style="background:#000; padding:20px 40px; border:2px solid #fff; text-align:center;">
        <h2 id="msg-txt" style="color:var(--gold); margin:0;">MESSAGE</h2>
    </div>
</div>

<div id="ov-travel" class="overlay" style="background:#050505; z-index:300;">
    <h2 style="color:#fff; letter-spacing:3px;">TRAVERSING DEPTHS...</h2>
    <div class="travel-bar"><div id="travel-fill" class="travel-fill"></div></div>
</div>

<div id="modal" class="overlay">
    <div class="modal-box">
        <h2 id="modal-h" style="color:var(--gold); margin-top:0;">TITLE</h2>
        <div id="modal-b" style="color:#ccc; margin:20px 0; line-height:1.5;">Content</div>
        <div id="modal-act">
            <button class="modal-btn" onclick="closeModal()">CONTINUE</button>
        </div>
    </div>
</div>

<script>
/* ================= CONFIG ================= */
const CFG = {
    startGold: 50, goldMin: 20, goldMax: 25,
    enemyTurn: 10.0, qte: 4.0, travel: 1200,
    healCost: 0.2, healAmt: 0.1
};

const THEMES = [
    { name: "COLOSSEUM", col: "tan", diff: 1.5 },
    { name: "FIGHTER'S CRYPT", col: "darkblue", diff: 1.8 },
    { name: "MARBLE CAVES", col: "grey", diff: 2.2 },
    { name: "IRIDIUM MINES", col: "purple", diff: 2.7 },
    { name: "GREENFIRE", col: "darkgreen", diff: 3.0 },
    { name: "BURNED NEST", col: "grey", diff: 3.3 },
    { name: "CRYSTAL CATACOMBS", col: "darkpurple", diff: 3.7 },
    { name: "CASTLE WASTES", col: "darkred", diff: 4.5 },
    { name: "DEEP NEST", col: "darkgrey", diff: 5.2 },
    { name: "OBSIDIAN VOID", col: "darkbrown", diff: 6.0 },
    { name: "HELL", col: "red", diff: 7.5 }
];

/* ================= DATABASE ================= */
const DB_ITEMS = [
    { id:'w0a', type:'weapon', tier:0, name:'Rusty Shiv', dmg:10, val:30, desc:"Barely even sharp. Found in the Colosseum's trash pile. (10 DMG)" },
    { id:'w0b', type:'weapon', tier:0, name:'Sandstone Sword', dmg:14, val:35, desc:'A sword forged out of compacted sand under the Colosseum. (14 DMG)' },
    { id:'w0c', type:'weapon', tier:0, name:'Beast Bone', dmg:4, val:100, desc:'A low damage fossile from the ancient Gigantasourous. Sells for alot though. (4 DMG)' },
    { id:'w0d', type:'weapon', tier:0, name:'Marble Blade', dmg:18, val:50, desc:'The strong blade forged by the strongest of Gladiators. (18 DMG)' },
    { id:'a0a', type:'armor', tier:0, name:'Ragged Tunic', def:3, val:30, desc:'A basic cloth given to the weaker Gladiators. (3 DEF)' },
    { id:'a0b', type:'armor', tier:0, name:'Marble Chestplate', def:6, val:50, desc:'A strong plate given to the strongest Gladiator. (6 DEF)' },
    { id:'s0a', type:'spell', tier:0, name:'Sandstorm', dmg:16, cost:5, val:30, desc:'A sandstorm that does damage to a enemy. (16 DMG | 5 MP)' },
    { id:'s0b', type:'spell', tier:0, name:'Earthern Dig', dmg:28, cost:25, val:75, desc:'Eject raw marble, straight from the hollows of The Caves. (28 DMG | 25 MP)' },

    { id:'w1a', type:'weapon', tier:1, name:'Golden Crown', dmg:10, val:150, desc:"A sharp crown that really doesn't pack a punch. Luckily, it sells for alot." },
    { id:'w1b', type:'weapon', tier:1, name:'Rock Launcher', dmg:18, val:70, desc:'An ancient arrow mechanism that can shoot rocks pretty fast. Most likely forged by the Gladiator Gagnolius. Not his strongest weapon though... (18 DMG)' },
    { id:'w1c', type:'weapon', tier:1, name:'Bandit Skull', dmg:16, val:60, desc:"The skull of a once great bandit who tried to rob Gagnolius's Vault. Sharpened by his ghost. (16 DMG)" },
    { id:'w1d', type:'weapon', tier:1, name:"The Protector", dmg:26, val:150, desc:'The blade Gagnolius himself used against the beast. Made out of diamond forged by the Void Master in the catacombs. (26 DMG)' },
    { id:'a1a', type:'armor', tier:1, name:'Golden Plate', def:8, val:70, desc:'A gold plate worn by Gagnolius in is youth, during his time in the Colosseum. (8 DEF)' },
    { id:'a1b', type:'armor', tier:1, name:'Eyepiece', def:18, val:200, desc:"Pure metal placed over Gagnolius's fallen eye. It was very important to him, and forged by The Dream Catcher. (18 DEF)" },
    { id:'s1a', type:'spell', tier:1, name:'Rise', dmg:34, cost:25, val:150, desc:'Summon The Fallen Gladiator himself! (34 DMG | 25 MP)' },
    { id:'s1b', type:'spell', tier:1, name:'Calvary', dmg:26, cost:20, val:100, desc:"A book written from the King himself. Any time he needed, he could summon the Kingdom's calvary to assist in his fight.(26 DMG | 20 MP)" },

    { id:'w2a', type:'weapon', tier:2, name:'Golden Sword', dmg:20, val:125, desc:"A gold sword, formed naturally. Noone has been in these caves for centuries. (20 DMG)" },
    { id:'w2b', type:'weapon', tier:2, name:'Diamond Sword', dmg:24, val:150, desc:"A diamond blade forged as one of Gagnolius's swords in his failed journey as a blacksmith. (24 DMG)" },
    { id:'w2c', type:'weapon', tier:2, name:'Marble Dagger', dmg:22, val:75, desc:"A short hand weapon made from the most common material in si. (22 DMG)" },
    { id:'w2d', type:'weapon', tier:2, name:"Obsidian Dagger", dmg:26, val:150, desc:'"We must spread the Void thoughout the underlayers of Carallious. That is the first step. -The Void Master" (26 DMG)' },
    { id:'a2', type:'armor', tier:2, name:'Diamond Plate', def:14, val:150, desc:"A chestplate somehow naturally formed from the small amount of diamonds in the Caves. (18 DEF)" },
    { id:'s2a', type:'spell', tier:2, name:'Landfall', dmg:38, cost:20, val:150, desc:'The rocks from the cave roof fall on your opponent! (38 DMG | 20 MP)' },
    { id:'s2b', type:'spell', tier:2, name:'Golden Reach', dmg:43, cost:30, val:200, desc:"Golden ore stretches from the cave walls to crush your enemy! (43 DMG | 30 MP)" },

    { id:'w3a', type:'weapon', tier:3, name:'Iridium Blade', dmg:32, val:175, desc:"A blade forged with dedication and metal. Forged by The Dream Catcher on his way to Gagnolius's vault. (32 DMG)" },
    { id:'w3b', type:'weapon', tier:3, name:'Sharp Rock', dmg:2, val:1, desc:"Gagnolius's last attempt at becoming a blacksmith. After the King saw this he was sent to the Colosseum. (2 DMG)" },
    { id:'w3c', type:'weapon', tier:3, name:'Energy Sword', dmg:36, val:200, desc:'Made from pure iron and iridium, this sword was a strong weapon from the Void Master. (36 DMG)' },   
    { id:'a3', type:'armor', tier:3, name:'Iridium Armor', def:20, val:250, desc:"Armor made from the rarest material in all of Carallious. (20 DEF)" },
    { id:'s3a', type:'spell', tier:3, name:'Energy Blast', dmg:40, cost:15, val:150, desc:'Channel Iridum through the tip of your blade to send a Energy Blast. (40 DMG | 15 MP)' },

    { id:'w4a', type:'weapon', tier:4, name:'Copper Dagger', dmg:20, val:50, desc:"Copper is common in the Greenfire caves. Not very strong, but pretty cheap. (32 DMG)" },
    { id:'a4', type:'armor', tier:4, name:'Vine Armor', def:8, val:50, desc:"Just not very good. (8 DEF)" },
    { id:'s4a', type:'spell', tier:4, name:'Vine Grab', dmg:40, cost:15, val:150, desc:'Grab your enemy with a vine to the head. (40 DMG | 15 MP)' },
    { id:'s4b', type:'spell', tier:4, name:'Fireball', dmg:30, cost:10, val:175, desc:'Incenerate your opponent. (30 DMG | 10 MP)' },
    { id:'s4c', type:'spell', tier:4, name:'Lifesteal', dmg:1000, cost:100, val:175, desc:"Steal the life out of anyone's veins.(1000 DMG | 100 MP)"  },

    { id:'w5a', type:'weapon', tier:5, name:'Spider Leg', dmg:38, val:200, desc:"The burned nest is a graveyard of somewhere that used to be full of life. (38 DMG)" },
    { id:'w5b', type:'weapon', tier:5, name:'Ash Blade', dmg:44, val:250, desc:"An ashen blade, a fossile of the burned life that used to be here. (44 DMG)" },
    { id:'a5', type:'armor', tier:5, name:'Burnt Plate', def:24, val:275, desc:"Armor burned by the memory of the nest. Now they have all died, or moved somewhere else. (24 DEF)" },
    { id:'s5a', type:'spell', tier:5, name:'Fire Beam', dmg:50, cost:25, val:175, desc:'Send a beam of fire to anyone who threatens you. (50 DMG | 25 MP)' },
    { id:'s5b', type:'spell', tier:5, name:'Bugfall', dmg:40, cost:5, val:175, desc:'Bugs fall from the sky, striking anyone near. (40 DMG | 5 MP)' },

    { id:'w6a', type:'weapon', tier:6, name:'Crystal Blade', dmg:46, val:275, desc:"A blade forged by The Dream Catcher during his life in the catacombs. Now he is nowhere to be found. (46 DMG)" },
    { id:'a6', type:'armor', tier:6, name:'Crystal Armor', def:46, val:275, desc:"The Dream Catcher was always better at making armor then swords. (8 DEF)" },
    { id:'s6a', type:'spell', tier:6, name:'Shine', dmg:44, cost:5, val:250, desc:'A bliding light from the crystals in the Catacombs. (30 DMG | 5 MP)' },

    { id:'w7a', type:'weapon', tier:7, name:'Royal Blade', dmg:50, val:300, desc:"The King's personal blade. Now, the only thing down here is wastes and bodies. But the King is gone. (50 DMG)" },
    { id:'w7b', type:'weapon', tier:7, name:"Knight's Sword", dmg:48, val:280, desc:"A sword taken off of a Knight's body. His skin had black cracks all over. (48 DMG)" },
    { id:'a7', type:'armor', tier:7, name:"King's Armor", def:26, val:275, desc:"Found in the King's chambers. There is a black crack in it that splits across the body of the shield. (26 DEF)" },
    { id:'s7a', type:'spell', tier:7, name:"Necromancer's Rise", dmg:60, cost:20, val:300, desc:"Ressurect a Kight's body and use it to fight. (60 DMG | 20 MP)" },

    { id:'w8a', type:'weapon', tier:8, name:'Dark Ashen Blade', dmg:55, val:325, desc:"A dark sword forged by the insects in the Deep Nest. (55 DMG)" },
    { id:'a8', type:'armor', tier:8, name:"Black Armor", def:30, val:325, desc:"A armor piece stained with black from the void. This nest is where the insects moved to, they won't let you near. (30 DEF)" },
    { id:'s8a', type:'spell', tier:8, name:"Web Grab", dmg:60, cost:15, val:325, desc:"Grab anyone with a web from the Deepnest. (60 DMG | 15 MP)" },

    { id:'w9a', type:'weapon', tier:9, name:'Obsidian Sword', dmg:65, val:375, desc:"Raw obsidain formed deep in this void. Overflowing with a black ooze throughout the sword, infecting you. (65 DMG)" },
    { id:'w9b', type:'weapon', tier:9, name:'Portal Fragment', dmg:60, val:350, desc:"A fragment of a mysterious portal, leading to another dimension. Sitting on top is the King's crown. (60 DMG)" },
    { id:'w9b', type:'weapon', tier:9, name:'Void Blade', dmg:80, val:400, desc:"A sword infinitely sharp with a flade you can put your hand through. This Void is filling your veins with black. (80 DMG)" },
    { id:'a9a', type:'armor', tier:9, name:"Obsidian Armor", def:35, val:350, desc:"Obsidian pieces forged by The Void Master in his workshop. The only thing left is the black liquid. (35 DEF)" },
    { id:'a9b', type:'armor', tier:9, name:"Void Chestplate", def:40, val:400, desc:"The Void Master's final creation before he crossed the portal. They had to escape the void somehow. (40 DEF)" },
    { id:'s9a', type:'spell', tier:9, name:"Portal", dmg:100, cost:25, val:400, desc:"Summon the portal to another dimension the three people walked into. The King, The Dream Catcher, and The Void Master. (100 DMG | 25 MP)" },

    { id:'s10a', type:'weapon', tier:10, name:"The King's Blessing", dmg:100, cost:0, val:500, desc:"The King's blessing straight from the fire of Hell. (100 DMG | 0 MP)" },
    { id:'s10b', type:'armor', tier:10, name:"The Void Master's Blessing", dmg:100, cost:0, val:500, desc:"The Void Master's blessing straight from the fire of Hell. (100 DMG | 0 MP)" },
    { id:'s10c', type:'spell', tier:10, name:"The Dream Catcher's Blessing", dmg:100, cost:0, val:500, desc:"The Dream Catcher's blessing straight from the fire of Hell. (100 DMG | 0 MP)" },
];

/* ================= ENEMIES ================= */
const ALL_PATS = ['rain', 'dash', 'track', 'snake', 'spiral'];
const DB_ENEMIES = [];
THEMES.forEach((t, i) => {
    for(let j=1; j<=4; j++) {
        const p1 = ALL_PATS[(i+j) % ALL_PATS.length];
        const p2 = ALL_PATS[(i+j+1) % ALL_PATS.length];
        DB_ENEMIES.push({ name: `${t.name} Mob ${j}`, tier: i, hp: 20+(i*20)+(j*5), icon: ['âš”','âš”','âš”','âš”'][j%4], patterns: [p1, p2] });
    }
    DB_ENEMIES.push({ name: `${t.name} BOSS`, tier: i, hp: 80+(i*40), boss: true, icon: 'ðŸ‘¹', patterns: ['spiral', 'track'] });
});

const TRADERS = [{ id:0, name:'Mage', lv:1, xp:0, type:'spell' }, { id:1, name:'Smith', lv:1, xp:0, type:'gear' }];

/* ================= STATE ================= */
let player = { gold: CFG.startGold, stash:[], loadout:{}, stats:{hp:100, maxHp:100, mana:100, maxMana:100} };
let game = { active:false, floor:0, room:0, goldRun:0, enemy:null, currentPattern:null };
let stocks = [[],[]];
let keys = { w:false, a:false, d:false, space:false };
let modalCb = null;

/* ================= INIT ================= */
window.onload = () => {
    if(localStorage.getItem('itd_v27')) {
        const d = JSON.parse(localStorage.getItem('itd_v27')); player = d.player;
    }
    if(player.stash.length === 0 && !player.loadout.weapon) player.stash.push({...DB_ITEMS[0]});
    refreshStocks(); renderHub();
    
    // Using code instead of key for reliability
    document.addEventListener('keydown', e=>{ 
        if(e.code === 'KeyW' | e.code === 'ArrowUp') keys.w = true;
        if(e.code === 'KeyA' | e.code === 'ArrowLeft') keys.a = true;
        if(e.code === 'KeyD' | e.code === 'ArrowRight') keys.d = true;
        if(e.code === 'Space') { e.preventDefault(); keys.space = true; }
        
        // QTE Input
        const k=e.key.toLowerCase(); 
        if(qte.active) checkQTE(k); 
    });
    
    document.addEventListener('keyup', e=>{ 
        if(e.code === 'KeyW' | e.code === 'ArrowUp') keys.w = false;
        if(e.code === 'KeyA' | e.code === 'ArrowLeft') keys.a = false;
        if(e.code === 'KeyD' | e.code === 'ArrowRight') keys.d = false;
        if(e.code === 'Space') keys.space = false;
    });

    document.addEventListener('mousemove', e => {
        const tt = document.getElementById('tooltip');
        if(tt.style.display === 'block') { tt.style.left = (e.pageX + 15) + 'px'; tt.style.top = (e.pageY + 15) + 'px'; }
    });
};

function save() { localStorage.setItem('itd_v27', JSON.stringify({player})); }
function wipeData() { localStorage.removeItem('itd_v27'); location.reload(); }

/* ================= TRADERS & HUB ================= */
function refreshStocks() {
    stocks = [[],[]];
    stocks[0] = DB_ITEMS.filter(i=>i.type==='spell').sort(()=>0.5-Math.random()).slice(0,2);
    stocks[1] = DB_ITEMS.filter(i=>i.type!=='spell').sort(()=>0.5-Math.random()).slice(0,2);
}
function buy(tid, iid) {
    const it = stocks[tid][iid];
    if(player.gold >= it.val) { player.gold -= it.val; player.stash.push({...it}); stocks[tid].splice(iid,1); renderTrader(); renderHub(); } else alert("Not enough Gold");
}
function renderTrader() {
    const c = document.getElementById('trader-list'); c.innerHTML='';
    TRADERS.forEach((t,i)=>{
        let h = `<div class="trader-row"><div class="trader-info"><strong>${t.name}</strong></div><div style="display:flex; gap:10px">`;
        stocks[i].forEach((it,ii)=>{
            h += `<div class="card r-${typeof it.tier === 'number' ? Math.min(6,it.tier) : 'hell'}" onclick="buy(${i},${ii})" onmouseenter="showTooltip(this, ${ii}, 'trader', ${i})" onmouseleave="hideTooltip()"><small>${it.name}</small><br><span style="color:var(--gold)">${it.val} G</span></div>`;
        });
        h+=`</div></div>`; c.innerHTML += h;
    });
}
function switchScreen(s) {
    hideTooltip();
    document.querySelectorAll('.screen').forEach(e=>e.classList.remove('active'));
    document.querySelectorAll('.nav-btn').forEach(e=>e.classList.remove('active'));
    document.getElementById('screen-'+s).classList.add('active');
    if(s==='trader') renderTrader(); if(s==='hub') renderHub();
}
function renderHub() {
    hideTooltip(); document.getElementById('hud-gold').innerText = player.gold;
    const g = document.getElementById('stash-grid'); g.innerHTML = '';
    player.stash.forEach((it,i)=>{
        const d = document.createElement('div'); d.className = `card r-${typeof it.tier === 'number' ? Math.min(6,it.tier) : 'hell'}`;
        const sellBtn = document.createElement('button'); sellBtn.className = 'btn-sell'; sellBtn.innerText = '$';
        sellBtn.style.position='absolute'; sellBtn.style.top='5px'; sellBtn.style.right='5px';
        sellBtn.onclick = (e) => { e.stopPropagation(); sellItem(i); };
        d.innerHTML += `<div class="card-top"><span class="card-name">${it.name}</span></div><span class="card-type">${it.type}</span>`;
        d.appendChild(sellBtn);
        d.onclick = () => equip(i); d.onmouseenter = () => showTooltip(d, i, 'stash'); d.onmouseleave = () => hideTooltip();
        g.appendChild(d);
    });
    updateSlots(); save();
}
function sellItem(i) {
    hideTooltip(); const item = player.stash[i]; const price = Math.ceil(item.val * 0.8);
    player.gold += price; player.stash.splice(i, 1); renderHub(); 
}
function showTooltip(el, idx, source, traderIdx) {
    let item = (source === 'stash') ? player.stash[idx] : stocks[traderIdx][idx];
    if(!item) return;
    const tt = document.getElementById('tooltip');
    document.getElementById('tt-title').innerText = item.name;
    document.getElementById('tt-title').style.color = (item.tier === 10) ? 'var(--r-hell)' : `var(--r${Math.min(4, item.tier)})`;
    document.getElementById('tt-meta').innerText = `Tier ${item.tier} | ${item.type}`;
    document.getElementById('tt-desc').innerText = item.desc;
    tt.style.display = 'block';
}
function hideTooltip() { document.getElementById('tooltip').style.display = 'none'; }
function equip(i) {
    hideTooltip(); const it = player.stash[i]; let s = it.type; if(s==='spell') s = player.loadout.spell1?'spell2':'spell1';
    if(player.loadout[s]) player.stash.push(player.loadout[s]);
    player.loadout[s] = it; player.stash.splice(i,1); renderHub();
}
function unequip(s) { if(player.loadout[s]) { player.stash.push(player.loadout[s]); player.loadout[s]=null; renderHub(); } }
function updateSlots() {
    ['weapon','armor','spell1','spell2'].forEach(s=>{
        const e = document.getElementById('slot-'+s);
        if(player.loadout[s]) { e.innerText = player.loadout[s].name; e.classList.add('filled'); }
        else { e.innerText = s.toUpperCase(); e.classList.remove('filled'); }
    });
}

/* ================= GAME ENGINE ================= */
function startRun() {
    if(!player.loadout.weapon) return alert("Need Weapon!");
    hideTooltip();
    game = {active:true, floor:0, room:0, goldRun:0, enemy:null};
    player.stats.hp = player.stats.maxHp; player.stats.mana = player.stats.maxMana;
    document.getElementById('nav-bar').style.display='none';
    switchScreen('game');
    loadRoom();
}
function travel() {
    document.getElementById('controls').innerHTML = '';
    const ov = document.getElementById('ov-travel'); const bar = document.getElementById('travel-fill');
    ov.style.display = 'flex'; bar.style.width = '0%';
    setTimeout(() => { bar.style.width = '100%'; }, 50);
    setTimeout(() => { ov.style.display = 'none'; loadRoom(); }, CFG.travelTime);
}
function loadRoom() {
    game.room++; game.enemy = null; updateHUD();
    const th = THEMES[Math.min(game.floor, 10)];
    document.documentElement.style.setProperty('--theme', th.col);
    document.getElementById('floor-txt').innerText = `${th.name} - FLOOR ${game.floor+1}`;
    document.getElementById('narrative').style.display = 'block';
    document.getElementById('combat-ui').style.display = 'none';
    const c = document.getElementById('controls'); c.innerHTML = '';

    const isHell = game.floor >= 10;
    const isBoss = !isHell && game.room === 8;

    if(isHell) {
        setRoom("HELL", "Endless fire.");
        addBtn("FIGHT", "Demon", ()=>spawnEnemy(false));
        addBtn("EXTRACT", "Escape", extract);
    } else if(isBoss) {
        setRoom("BOSS", "The guardian.");
        spawnEnemy(true);
    } else {
        if(game.room === 1) {
            setRoom("ENTRANCE", "Begin.");
            addBtn("FORWARD", "Go", travel);
        } else {
            if(Math.random()>0.25) {
                setRoom("ENEMY", "Blocking path.");
                spawnEnemy(false);
            } else {
                setRoom("EMPTY", "Quiet.");
                addBtn("LEFT", "Dark path", travel);
                addBtn("RIGHT", "Wet path", travel);
            }
        }
    }
}
function setRoom(t,d) { document.getElementById('room-title').innerText=t; document.getElementById('room-desc').innerText=d; }
function addBtn(t,s,cb) {
    const b = document.createElement('div'); b.className='btn-act';
    b.innerHTML=`<strong>${t}</strong><small>${s}</small>`; b.onclick=cb;
    document.getElementById('controls').appendChild(b);
}

/* ================= COMBAT ================= */
function spawnEnemy(isBoss) {
    const tier = Math.min(10, game.floor);
    const pool = DB_ENEMIES.filter(e => e.tier === tier && (isBoss ? e.boss : !e.boss));
    const tpl = pool[Math.floor(Math.random()*pool.length)] || DB_ENEMIES[0];
    game.enemy = { ...tpl, maxHp: tpl.hp * (isBoss?2:1) * (1+(game.room*0.1)) };
    game.enemy.hp = game.enemy.maxHp;
    pickEnemyPattern();
    document.getElementById('narrative').style.display='none';
    document.getElementById('combat-ui').style.display='flex';
    document.getElementById('enemy-name').innerText = game.enemy.name;
    document.getElementById('enemy-icon').innerText = game.enemy.icon;
    updateEnemyHP();
    renderActions();
}
function pickEnemyPattern() {
    const pats = game.enemy.patterns;
    game.currentPattern = pats[Math.floor(Math.random() * pats.length)];
    document.getElementById('enemy-pat').innerText = game.currentPattern.toUpperCase();
}
function renderActions() {
    document.getElementById('canvas-box').style.display = 'none';
    const c = document.getElementById('controls'); c.innerHTML = '';
    const healBtn = document.createElement('div');
    healBtn.className = 'btn-act btn-heal';
    healBtn.innerHTML = `<strong>HEAL TOOL</strong><small>Cost 10% MP -> Heal 10% HP</small>`;
    healBtn.onclick = useHealTool;
    c.appendChild(healBtn);
    const w = player.loadout.weapon;
    addBtn(`ATTACK (${w.name})`, `Seq. ${w.dmg} DMG`, ()=>startQTE(w.dmg));
    ['spell1','spell2'].forEach(s=>{
        const sp = player.loadout[s];
        if(sp) addBtn(`CAST ${sp.name}`, `${sp.dmg} DMG (${sp.cost} MP)`, ()=>startQTE(sp.dmg, sp.cost));
    });
}
function useHealTool() {
    const cost = 10;
    if(player.stats.mana >= cost) {
        player.stats.mana -= cost;
        const heal = 10;
        player.stats.hp = Math.min(player.stats.maxHp, player.stats.hp + heal);
        updateHUD();
        showMsg("HEALED", "var(--mp)");
    } else alert("Not enough Mana");
}

/* ================= QTE & DODGE ================= */
let qte = {active:false, seq:[], idx:0, val:0, cost:0, timerInt:null};
function startQTE(val, cost=0) {
    if(cost > 0 && player.stats.mana < cost) return alert("No MP");
    player.stats.mana -= cost; updateHUD();
    qte = {active:true, seq:[], idx:0, val:val, cost:cost};
    const ch = ['W','A','S','D'];
    for(let i=0; i<8; i++) qte.seq.push(ch[Math.floor(Math.random()*4)]);
    document.getElementById('ov-qte').style.display='flex';
    const c = document.getElementById('qte-keys'); c.innerHTML='';
    qte.seq.forEach(k=>{ const d=document.createElement('div'); d.className='key-box'; d.innerText=k; c.appendChild(d); });
}
function checkQTE(k) {
    const els = document.querySelectorAll('.key-box');
    if(k === qte.seq[qte.idx].toLowerCase()) { els[qte.idx].classList.add('key-active'); qte.idx++; if(qte.idx===8) endQTE(true); } else endQTE(false);
}
function endQTE(success) {
    clearInterval(qte.timerInt); qte.active=false;
    document.getElementById('ov-qte').style.display='none';
    if(success) {
        game.enemy.hp -= qte.val; updateEnemyHP();
        if(game.enemy.hp <= 0) { game.enemy.hp = 0; updateEnemyHP(); win(); } else startEnemyTurn();
    } else showMsg("ATTACK FAILED", "var(--hp)", 1000, startEnemyTurn);
}

/* --- FIXED PHYSICS DODGE --- */
let cvs, ctx, dodgeInt, p={x:300,y:175,vx:0,vy:0}, bullets=[], canJump=true, locked=false, lockTimer=0;

function startEnemyTurn() {
    pickEnemyPattern();
    document.getElementById('ov-count').style.display='flex';
    let c = 3; document.getElementById('count-num').innerText = c;
    const int = setInterval(()=>{
        c--; if(c>0) document.getElementById('count-num').innerText=c;
        else { clearInterval(int); document.getElementById('ov-count').style.display='none'; runDodge(); }
    }, 1000);
}
function runDodge() {
    document.getElementById('controls').innerHTML = '';
    document.getElementById('canvas-box').style.display = 'block';
    cvs = document.getElementById('gameCanvas'); ctx = cvs.getContext('2d');
    bullets = []; 
    let diff = THEMES[Math.min(game.floor, 10)].diff;
    if(game.enemy.boss) diff *= 1.5;
    
    // Reset Physics
    p.x = 300; p.y = 175; p.vy = 0; p.vx = 0; locked = false; lockTimer = 0;
    let startTime = Date.now();
    
    dodgeInt = setInterval(()=>{
        let elapsed = Date.now() - startTime;
        let remaining = Math.max(0, 10 - (elapsed / 1000));
        
        ctx.fillStyle='#000'; ctx.fillRect(0,0,600,350);
        ctx.font = "20px Courier New"; ctx.fillStyle = "#444"; ctx.textAlign = "center";
        ctx.fillText(remaining.toFixed(1) + "s", 300, 30);

        // PHYSICS
        p.vy += 0.25; // Gravity

        // Horizontal Movement
        if(!locked) {
            if(keys.a) p.x -= 5;
            if(keys.d) p.x += 5;
        } else {
            // Apply Wall Bounce Velocity
            p.x += p.vx;
            p.vx *= 0.9; // Friction
            lockTimer--;
            if(lockTimer <= 0) locked = false;
        }

        // JUMP LOGIC
        if((keys.w || keys.space) && canJump) {
            canJump = false; // Enforce Tap
            
            // Left Wall Jump
            if(p.x <= 0) { 
                p.vy = -9; 
                p.vx = 10; // Kick right
                locked = true; 
                lockTimer = 20; // frames
            } 
            // Right Wall Jump
            else if(p.x >= 584) { 
                p.vy = -9; 
                p.vx = -10; // Kick left
                locked = true; 
                lockTimer = 20;
            } 
            // Normal Jump
            else if (p.y <= 2000){ 
                p.vy = -7; 
            }
        }
        if(!keys.w && !keys.space) canJump = true;

        // Vertical Movement
        p.y += p.vy;

        // Collisions
        if(p.x < 0) p.x = 0; 
        if(p.x > 584) p.x = 584;
        if(p.y > 334) { p.y = 334; p.vy = 0; } // Floor Stop
        if(p.y < 0) { p.y = 0; p.vy = Math.abs(p.vy) * 0.5; } // Ceiling Bounce

        ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--theme'); ctx.fillRect(p.x, p.y, 16, 16);
        updatePattern(diff);
        ctx.fillStyle='#fff';
        for(let i=0; i<bullets.length; i++) {
            let b=bullets[i]; b.x+=b.vx; b.y+=b.vy; ctx.fillRect(b.x, b.y, 6, 6);
            if(b.x<p.x+16 && b.x+6>p.x && b.y<p.y+16 && b.y+6>p.y) {
                let dmg = 10 + (game.floor*2);
                if(player.loadout.armor) dmg -= Math.floor(player.loadout.armor.def);
                player.stats.hp -= Math.max(1, dmg);
                bullets.splice(i,1); i--; updateHUD(); ctx.fillStyle='red'; ctx.fillRect(0,0,600,350);
            }
        }
        if(player.stats.hp<=0) { clearInterval(dodgeInt); die(); }
        if(remaining<=0) { clearInterval(dodgeInt); renderActions(); }
    }, 16);
}
function updatePattern(diff) {
    const pat = game.currentPattern;
    const spd = (3 + (game.floor*0.5)) * diff;
    const rate = 0.05 * diff;
    if(Math.random() < rate) {
        let b = {x:0,y:0,vx:0,vy:0};
        if(pat === 'rain') { b.x=Math.random()*600; b.y=0; b.vy=spd; }
        else if(pat === 'dash') { b.x=600; b.y=Math.random()*350; b.vx=-spd*1.5; }
        else if(pat === 'track') { let a = Math.atan2(p.y, p.x-300); b.x=300; b.y=0; b.vx=Math.cos(a)*spd; b.vy=Math.sin(a)*spd; }
        else if(pat === 'nova') { b.x=300; b.y=175; let a=Math.random()*6.28; b.vx=Math.cos(a)*spd; b.vy=Math.sin(a)*spd; }
        else if(pat === 'snake') { b.x=Math.random()*600; b.y=0; b.vy=spd; b.vx=Math.sin(Date.now()/100)*2; }
        else if(pat === 'bounce') { b.x=0; b.y=Math.random()*350; b.vx=spd; b.vy=spd; }
        else { if(Math.random()>0.5) { b.x=Math.random()*600; b.y=0; b.vy=spd; } else { b.x=0; b.y=Math.random()*350; b.vx=spd; } }
        bullets.push(b);
    }
}

/* ================= RESOLUTION ================= */
function win() {
    const min = 10;
    const max = 50;
    const gold = Math.floor(Math.random() * (max - min)) * (game.floor +1);

    // FIXED GOLD UPDATE
    game.goldRun += gold;                  // gold earned this run
    player.gold += gold;                   // add to main gold pool
    document.getElementById('hud-gold').innerText = player.gold;  // update display
    save();                                // store in localStorage

    let lootMsg = `<span class="loot-text">+${gold} GOLD</span>`;

    const tier = Math.min(10, game.floor);
    const pool = DB_ITEMS.filter(i=>i.tier===tier);

    if(pool.length) {
        const item = pool[Math.floor(Math.random()*pool.length)];
        player.stash.push({...item});
        lootMsg += `<span class="loot-text" style="color:var(--gold)">FOUND: ${item.name}</span>`;
    }

    showMsg(`VICTORY!`, "var(--gold)", 2000, ()=>{
        showModal("LOOT", lootMsg);
        document.getElementById('modal-act').innerHTML =
           `<button class="modal-btn" onclick="${game.enemy.boss ? 'finishBoss()' : 'finishRoom()'}">CONTINUE</button>`;
    });
}


function finishRoom() { closeModal(); setRoom("CLEARED", "Room Secured."); updateRoom(); const c=document.getElementById('controls'); c.innerHTML=''; const h=document.createElement('div'); h.className='btn-act btn-heal'; h.innerHTML=`<strong>HEAL TOOL</strong><small>Cost 20% MP -> Heal 10% HP</small>`; h.onclick=useHealTool; c.appendChild(h); addBtn("CONTINUE", "Travel", travel); }
function finishBoss() { closeModal(); setRoom("VICTORY", "Floor Conquered."); addBtn("EXTRACT", "Leave", extract); addBtn("DESCEND", "Next Floor", descend); }
function descend() { game.floor++; game.room=0; travel(); }
function extract() {
    player.gold += game.goldRun; refreshStocks();
    showModal("EXTRACTED", `<span class="loot-text">SECURED: ${game.goldRun} GOLD</span>`);
    document.getElementById('modal-act').innerHTML = `<button class="modal-btn" onclick="closeModal(); document.getElementById('nav-bar').style.display='flex'; switchScreen('hub');">RETURN</button>`;
}
function die() {
    player.loadout = { weapon: null, armor: null,spell1: null, spell2: null };
    if(!player.stash.length) player.stash.push({...DB_ITEMS[0]});
    showModal("YOU DIED", "Gear Lost.");
    document.getElementById('modal-act').innerHTML = `<button class="modal-btn" onclick="closeModal(); document.getElementById('nav-bar').style.display='flex'; switchScreen('hub');">RETURN</button>`;
}

/* ================= UTILS ================= */
function showMsg(txt, col, dur, cb) {
    document.getElementById('msg-txt').innerText = txt; document.getElementById('msg-txt').style.color = col;
    document.getElementById('ov-msg').style.display='flex';
    setTimeout(()=>{ document.getElementById('ov-msg').style.display='none'; cb(); }, dur);
}
function showModal(t, m) { document.getElementById('modal-h').innerText=t; document.getElementById('modal-b').innerHTML=m; document.getElementById('modal').style.display='flex'; }
function closeModal() { document.getElementById('modal').style.display='none'; }
function updateHUD() {
    document.getElementById('bar-hp').style.width = (player.stats.hp/player.stats.maxHp)*100+'%';
    document.getElementById('bar-mp').style.width = (player.stats.mana/player.stats.maxMana)*100+'%';
}
function updateEnemyHP() { document.getElementById('enemy-hp').style.width = (game.enemy.hp/game.enemy.maxHp)*100+'%'; }

function updateRoom(n, max = 8) {
    document.getElementById("room-txt").textContent = `ROOM ${game.room}/8`;
}


</script>
</body>
</html>
